#!/bin/bash
set -euo pipefail

REPO_NAME="aserdev"
ARCH_DIR="$(pwd)/x86_64"
TMP_BASE="${HOME}/tmp/pkgs"

# 0. Ensure directories exist
mkdir -p "$TMP_BASE/packages" "$TMP_BASE/sources" "$TMP_BASE/build"

# 1. Nuke old repo files
echo "==> Cleaning old repo files..."
rm -f "$ARCH_DIR"/*.pkg.tar.* 2>/dev/null || true
rm -f "$ARCH_DIR/$REPO_NAME".db* "$ARCH_DIR/$REPO_NAME".files* 2>/dev/null || true

# 2. Build packages
echo "==> Building packages..."
find . -type f -name PKGBUILD | while read -r pkgbuild; do
    dir="$(dirname "$pkgbuild")"
    echo "--> Building in $dir"
    (
        cd "$dir"

        # Clean up any old build stuff in local dir
        rm -rf src pkg *.pkg.tar.* 2>/dev/null || true

        # Run makepkg with custom dirs
        makepkg -sf --noconfirm --skipchecksums --skippgpcheck \
                PKGDEST="$TMP_BASE/packages" \
                SRCDEST="$TMP_BASE/sources" \
                BUILDDIR="$TMP_BASE/build" \
                -c

        # Move built package(s) to your repo directory
        mv "$TMP_BASE/packages"/*.pkg.tar.* "$ARCH_DIR"/
    )
done

cd "$ARCH_DIR"

# 3. Prune old versions
echo "==> Pruning old versions..."
shopt -s nullglob
for pkg in *.pkg.tar.*; do
    base="${pkg%-*-*-*}" 
    latest=$(ls "$base"-*.pkg.tar.* | sort -V | tail -n1)
    for old in $base-*.pkg.tar.*; do
        [ "$old" = "$latest" ] && continue
        echo "Removing old: $old"
        rm -f "$old"
    done
done
shopt -u nullglob

# 4. Rebuild database
echo "==> Rebuilding database..."
if ls *.pkg.tar.* >/dev/null 2>&1; then
    repo-add "$REPO_NAME.db.tar.zst" ./*.pkg.tar.*
    echo "==> Making plain copies (GitHub‑safe)…"
    rm -rf "$REPO_NAME.db" "$REPO_NAME.files"
    cp -f "$REPO_NAME.db.tar.zst"     "$REPO_NAME.db"
    cp -f "$REPO_NAME.files.tar.zst" "$REPO_NAME.files"
else
    echo "==> No packages found, skipping repo‑add…"
fi

# 5. Clean PKGBUILD dirs (only src/ and pkg/)
echo "==> Cleaning PKGBUILD directories…"
find ./PKGBUILD -type d \( -name 'src' -o -name 'pkg' \) -print 2>/dev/null | while read -r d; do
    echo "--> Removing $d"
    rm -rf "$d"
done

echo "==> Done ✅"
