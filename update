#!/bin/bash
set -euo pipefail

REPO_NAME="aserdev"
ARCH_DIR="$(pwd)/x86_64"

mkdir -p "$ARCH_DIR"

echo "==> Building packages..."
find . -type f -name PKGBUILD | while read -r pkgbuild; do
    dir="$(dirname "$pkgbuild")"
    echo "--> Building in $dir"
    (
        cd "$dir"
        rm -f *.pkg.tar.* src/ pkg/ || true
        makepkg -sf --noconfirm --skipchecksums --skippgpcheck
        mv *.pkg.tar.zst "$ARCH_DIR"/
    )
done

cd "$ARCH_DIR"

echo "==> Pruning old versions..."
for pkg in *.pkg.tar.zst; do
    base="${pkg%-*-*-*}" # strip version+arch
    latest=$(ls "$base"-*.pkg.tar.zst | sort -V | tail -n1)
    for old in "$base"-*.pkg.tar.zst; do
        if [[ "$old" != "$latest" ]]; then
            echo "Removing old: $old"
            rm -f "$old"
        fi
    done
done

echo "==> Rebuilding database..."
rm -f "$REPO_NAME".db* "$REPO_NAME".files* || true
repo-add "$REPO_NAME.db.tar.zst" *.pkg.tar.zst

echo "==> Fixing pacman symlink compatibility..."
# Make sure pacman sees both tar.zst and plain names
ln -sf "$REPO_NAME.db.tar.zst"     "$REPO_NAME.db"
ln -sf "$REPO_NAME.files.tar.zst" "$REPO_NAME.files"

echo "==> Done âœ…"

